import os
import re
from collections import defaultdict
from PIL import Image
from pyzbar.pyzbar import decode

# Store normalized_text -> list of (filename, raw_text)
results = defaultdict(list)

def normalize(text):
    """
    Remove scan number noise like: (scan #1234)
    """
    return re.sub(r"\s*\(scan\s*#\d+\)", "", text).strip()

# Scan all QR images in the current directory
for file in os.listdir("."):
    if file.lower().endswith((".png", ".jpg", ".jpeg")):
        try:
            img = Image.open(file)
            decoded_objs = decode(img)

            for obj in decoded_objs:
                raw_text = obj.data.decode("utf-8", errors="ignore").strip()
                clean_text = normalize(raw_text)
                results[clean_text].append((file, raw_text))

        except Exception:
            pass

# ---- UNIQUE LOGICAL MESSAGES ----
print("\n[+] UNIQUE LOGICAL MESSAGES:\n")
for clean_text, entries in results.items():
    if len(entries) == 1:
        file, raw = entries[0]
        print(f"Clean : {clean_text}")
        print(f"Raw   : {raw}")
        print(f"File  : {file}")
        print("-" * 60)

# ---- FREQUENCY ANALYSIS ----
print("\n[+] RAREST MESSAGES (<= 3 occurrences):\n")
for clean_text, entries in sorted(results.items(), key=lambda x: len(x[1])):
    if len(entries) <= 3:
        print(f"[{len(entries)} times] {clean_text}")
        for file, raw in entries:
            print(f"  -> {file} | {raw}")
        print("-" * 60)
